<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SignAi (Beta 1.0)</title>
<style>
:root{
  --bg:#050a14;--panel:#0f1c38;--panel2:#0b152b;--glass:rgba(14,24,48,.72);
  --text:#eaf2ff;--muted:#a6b7ce;--border:#1a2947;
  --accent:#22b7ff;--accent2:#22e0d8;--ok:#16a34a;--bad:#ef4444;--expired:#3b82f6
}
*{box-sizing:border-box}html,body{height:100%}
body{
  margin:0;
  background:radial-gradient(80% 60% at 50% 0%,#081127 0%,#050a14 60%,#040813 100%);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--text)
}
.wrap{max-width:1040px;margin:0 auto;padding:16px 18px}
header{
  position:sticky;top:0;
  background:rgba(5,10,20,.9);
  backdrop-filter:blur(16px);
  border-bottom:1px solid var(--border);
  z-index:10;
}
.header-inner{
  display:flex;align-items:center;justify-content:space-between;
  gap:12px;padding:10px 2px;
}
.brand{display:flex;align-items:center;gap:12px}
.brand-logo{
  height:44px;width:44px;border-radius:10px;
  border:1px solid var(--border);
  background:radial-gradient(circle at 30% 0%,#22b7ff22,transparent 60%),linear-gradient(180deg,#0a1530,#071024);
  display:grid;place-items:center;overflow:hidden;
}
.brand-logo img{width:100%;height:100%;object-fit:cover}
.brand h1{margin:0;font-size:18px;font-weight:800;letter-spacing:.2px}
.brand .tag{margin:0;font-size:12px;color:var(--muted)}
.nav{
  display:flex;gap:6px;flex-wrap:wrap;justify-content:center;
  padding:4px 6px;
  border-radius:999px;
  background:radial-gradient(circle at 0 0,#22b7ff11,transparent 60%);
}
.tab{
  border-radius:999px;border:1px solid var(--border);
  padding:7px 12px;font-weight:800;
  cursor:pointer;background:var(--panel2);color:var(--text);
  transition:filter .2s,background .2s,transform .12s,border-color .2s,opacity .2s;
  font-size:13px;display:flex;align-items:center;gap:6px;
}
.tab span.emoji{font-size:14px}
.tab:hover{filter:brightness(1.08);transform:translateY(-1px)}
.tab.active{
  background:linear-gradient(120deg,var(--accent),var(--accent2));
  color:#062630;border-color:transparent;
  box-shadow:0 8px 25px rgba(34,183,255,.25);
}
.tab.minor{font-size:11px;padding:6px 9px;opacity:.55;filter:saturate(.9)}
.tab.minor:hover{opacity:.95;filter:brightness(1.06)}
.tab.minor span.emoji{font-size:13px}
.stepper{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin:10px 0 6px}
.step{
  display:flex;gap:6px;align-items:center;
  border:1px solid #26406c;background:#0b152b;
  color:#bcd0ea;border-radius:999px;
  padding:6px 11px;font-weight:700;font-size:12px
}
.step.active{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#062630;border-color:transparent}
.pager{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-top:8px}
.pill{
  border:1px solid var(--border);background:#0b152b;color:#cfe2ff;
  border-radius:999px;padding:8px 12px;font-weight:700;
  cursor:pointer;font-size:13px
}
.pill:disabled{opacity:.4;cursor:not-allowed}
.card{
  background:linear-gradient(180deg,var(--glass),transparent),var(--panel);
  border:1px solid var(--border);border-radius:14px;
  padding:16px;margin:12px 0
}
.helper{font-size:12.8px;color:var(--muted)}
.label{font-size:13px;color:var(--muted);margin:6px 0;font-weight:600}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.input,textarea{
  width:100%;background:var(--panel2);
  border:1px solid var(--border);color:var(--text);
  padding:10px;border-radius:10px;font-size:14px
}
textarea{min-height:110px;resize:vertical}
pre{
  background:var(--panel2);border:1px solid var(--border);
  border-radius:10px;padding:10px;overflow:auto;
  white-space:pre-wrap;word-wrap:break-word;
  font-family:ui-monospace,Consolas,Menlo,monospace;
  font-size:12.5px;line-height:1.4
}
.btn{
  border-radius:10px;border:1px solid var(--border);
  padding:10px 12px;font-weight:800;
  cursor:pointer;font-size:13px
}
.btn.primary{
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  color:#062630;border:0;
  box-shadow:0 8px 24px rgba(34,183,255,.18)
}
.resultBox{
  background:var(--panel2);border:2px solid var(--border);
  border-radius:12px;padding:12px;margin-top:8px;
  transition:box-shadow .2s,border-color .2s;
  text-align:left
}
.resultBox.ok{border-color:var(--ok);box-shadow:0 0 0 3px rgba(22,163,74,.16)}
.resultBox.bad{border-color:var(--bad);box-shadow:0 0 0 3px rgba(239,68,68,.16)}
.resultBox.expired{border-color:var(--expired);box-shadow:0 0 0 3px rgba(59,130,246,.16)}
.badgeFrame{display:flex;justify-content:center;align-items:center;min-height:200px}
.badgeClickableHint{font-size:11px;color:#9fb0c4;text-align:center;margin-top:6px;opacity:.8}
#b_preview.clickable{cursor:pointer;outline:2px solid rgba(34,183,255,.35);outline-offset:2px}
.bigStatus{font-weight:800;margin-bottom:6px}
.subStatus{font-size:12.6px;color:#a2b6d1}
#c_thumb{
  display:block;max-width:260px;
  border:1px solid var(--border);border-radius:10px;margin-top:8px
}
.hide{display:none}
footer{margin:18px 0 28px;color:var(--muted);font-size:12.5px;text-align:center}
.check-list{margin-top:10px;border-top:1px solid #1a2947;padding-top:10px;font-size:12.6px}
.check-row{display:flex;align-items:center;justify-content:space-between;margin:3px 0}
.check-label{color:#a2b6d1}
.check-pill{min-width:42px;text-align:center;padding:2px 8px;border-radius:999px;font-size:11px;font-weight:700}
.check-ok{color:#bbf7d0;background:rgba(22,163,74,.18);border:1px solid rgba(22,163,74,.6)}
.check-fail{color:#fecaca;background:rgba(239,68,68,.16);border:1px solid rgba(239,68,68,.7)}
.check-na{color:#e5e7eb;background:rgba(148,163,184,.16);border:1px solid rgba(148,163,184,.6)}
.check-legend{margin-top:8px;font-size:12px;color:#94a3b8}
.adminNav{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-start;padding:8px 0 2px}
.adminNav .tab{font-size:12px;padding:6px 10px}
.adminNav .tab.active{background:linear-gradient(120deg,var(--accent),var(--accent2));color:#062630;border-color:transparent}
</style>
</head>
<body>
<header>
  <div class="wrap header-inner">
    <div class="brand">
      <div class="brand-logo">
        <img id="signai_logo" src="logo.png" alt="SignAi">
      </div>
      <div>
        <h1>SignAi</h1>
        <p class="tag">BETA 1.0 - H.O.P 8.0</p>
      </div>
    </div>

    <nav class="nav">
      <button class="tab active" id="tb_trace" onclick="switchTab('trace', this)"><span class="emoji">üß¨</span><span>Use</span></button>
      <button class="tab" id="tb_verify" onclick="switchTab('verify', this)"><span class="emoji">üîç</span><span>Verify</span></button>
      <button class="tab minor" id="tb_admin" onclick="switchTab('admin', this)" title="PIN required"><span class="emoji">‚öôÔ∏è</span><span>Admin</span></button>
    </nav>
  </div>
</header>

<div class="wrap">
  <div class="stepper">
    <div class="step" id="st1">0. Vault</div>
    <div class="step" id="st2">1. Keys</div>
    <div class="step" id="st3">2. Mindprint</div>
    <div class="step" id="st4">3. Content Origin</div>
    <div class="step" id="st5">4. TRACE & Verify</div>
  </div>

  <div class="pager">
    <button id="btnPrev" class="pill" onclick="goPrev()">‚Üê Previous</button>
    <div></div>
    <button id="btnNext" class="pill" onclick="goNext()">Next ‚Üí</button>
  </div>

  <section id="tab-trace">
    <div class="card">
      <div class="label"><b>Use ‚Äî Create TRACE badge</b></div>
      <div class="helper">Write text, attach optional image, run origin scan (image only), then generate a signed badge.</div>

<div class="card">
        <div class="label"><b>Step 1 ‚Äì Mindprint (typing rhythm)</b></div>
        <textarea id="h_text" placeholder="Type 1‚Äì2 sentences with your own fingers‚Ä¶" onkeydown="logKey(event)" oninput="updateMindprint()"></textarea>
        <div class="helper" id="h_status">Waiting for typing‚Ä¶ (recommended)</div>
      </div>


      <div class="label" style="margin-top:10px">Text you want to sign</div>
      <textarea id="c_text" placeholder="Write/paste content‚Ä¶"></textarea>

      <div class="label" style="margin-top:8px">Attach image (optional)</div>
      <input id="c_image" type="file" accept="image/*" class="input" onchange="handleImage(event)">
      <img id="c_thumb" class="hide" alt="Preview">

      <div class="label" style="margin-top:10px"><b>Content Origin (Winston AI ‚Äî image only)</b></div>
      <div class="helper" id="co_status">Not analyzed yet.</div>
      <pre id="co_details" class="helper" style="white-space:pre-wrap;margin-top:4px;">‚Äì</pre>

      <div class="row" style="margin-top:8px">
        <button class="btn primary" onclick="buildBadge()">Analyze & create badge</button>
        <button class="btn" onclick="downloadSVG()">Download SVG</button>
        <button class="btn" onclick="downloadJSON()">Save proof (.json)</button>
      </div>

      <div class="label" style="margin-top:10px">Your TRACE badge (clickable)</div>
      <div id="b_preview" class="resultBox badgeFrame">
        <div class="helper">Badge will appear here after ‚ÄúAnalyze & create badge‚Äù.</div>
      </div>
      <div id="b_preview_hint" class="badgeClickableHint hide">Click the badge to jump directly to verification.</div>

      <div class="helper" style="margin-top:10px">Tip: if you want ‚Äúfull creator identity / keys / vault‚Äù, open Admin (PIN).</div>
    </div>
  </section>

  <section id="tab-verify" class="hide">
    <div class="card">
      <div class="label"><b>TraceNet (local)</b></div>
      <div class="label">creator_id</div>
      <div class="helper" id="tn_creator">(missing)</div>
      <div class="label" style="margin-top:6px">Registered?</div>
      <div class="helper" id="tn_regstatus">no</div>
    </div>

    <div class="card">
      <div class="label"><b>Verify</b></div>
      <div class="row" style="margin-bottom:10px">
        <button class="btn primary" onclick="quickVerifyCurrent()">Verify my latest badge</button>
      </div>

      <div class="label">Upload badge (.svg)</div>
      <input id="v_file" type="file" accept=".svg,image/svg+xml" class="input">

      <div class="label" style="margin-top:8px">If the badge used an image: upload the same image here</div>
      <input id="v_img" type="file" accept="image/*" class="input">

      <div style="margin-top:10px"><button class="btn" onclick="smartVerify()">Verify uploaded badge</button></div>

      <div class="label" style="margin-top:12px">Result</div>
      <div id="v_box" class="resultBox">
        <div id="v_human_status" class="bigStatus">No verification yet.</div>
        <div id="v_human_sub" class="subStatus">Click badge or upload a TRACE SVG.</div>
      </div>

      <div id="v_checks" class="check-list hide">
        <div class="bigStatus" style="margin-bottom:4px">Signal breakdown</div>

        <div class="check-row"><span class="check-label">Signature</span><span id="chk_sign" class="check-pill check-na">N/A</span></div>
        <div class="check-row"><span class="check-label">Time window (60s)</span><span id="chk_time" class="check-pill check-na">N/A</span></div>
        <div class="check-row"><span class="check-label">TraceNet identity</span><span id="chk_creator" class="check-pill check-na">N/A</span></div>
        <div class="check-row"><span class="check-label">Mindprint match</span><span id="chk_mind" class="check-pill check-na">N/A</span></div>
        <div class="check-row"><span class="check-label">Image hash</span><span id="chk_img" class="check-pill check-na">N/A</span></div>

        <div id="chk_summary" class="check-legend">Signal-score: ‚Äì/5. No checks run yet.</div>
      </div>
    </div>
  </section>

  <section id="tab-admin" class="hide">
    <div class="card">
      <div class="label"><b>Admin (PIN)</b></div>
      <div class="helper">This area is for creator identity, vault, and system docs. (PIN: 1996)</div>

      <div class="adminNav">
        <button class="tab active" id="ab_creator" onclick="switchAdmin('signai', this)"><span class="emoji">üóùÔ∏è</span><span>Creator</span></button>
        <button class="tab" id="ab_vault" onclick="switchAdmin('vault', this)"><span class="emoji">üîê</span><span>Vault</span></button>
        <button class="tab" id="ab_system" onclick="switchAdmin('about', this)"><span class="emoji">üìò</span><span>System</span></button>
      </div>
    </div>

    <section id="admin-signai">
      <div class="card">
        <div class="label"><b>Step 0 ‚Äì Unlock your BIO-ID Vault (recommended)</b></div>
        <div class="helper">For maximum safety, set and unlock your Vault password first (Vault subtab). You can‚Äôt create keys unless the Vault is initialized and unlocked.</div>
      </div>

      <div class="card">
        <div class="label"><b>Step 1 ‚Äì Create or import key pair</b></div>
        <div class="row">
          <button class="btn primary" onclick="createKey()">Create keypair</button>
          <button class="btn" onclick="downloadPub()">Download pub</button>
          <button class="btn" onclick="exportPriv()">Export private</button>
          <input id="k_import_file" type="file" accept=".json" class="input" style="max-width:320px" onchange="importPriv(event)">
        </div>
        <div class="label">Status</div>
        <pre id="k_status">No key yet.</pre>

        <div class="label">Public key (local)</div>
        <pre id="k_pub">(none)</pre>

        <div class="label">Private key (local ‚Äì NEVER share)</div>
        <div class="row">
          <pre id="k_priv" style="flex:1 1 auto;margin:0;">(hidden)</pre>
          <button class="btn" id="btnTogglePriv" onclick="togglePriv()">Show</button>
        </div>
      </div>

      
    </section>

    <section id="admin-vault" class="hide">
      <div class="card">
        <div class="label"><b>BIO-ID Vault (identity & keys)</b></div>
        <div class="helper" id="vault_status">Vault locked.</div>

        <div class="label" style="margin-top:8px">Vault password</div>
        <div class="row">
          <input id="vault_pass" type="password" class="input" style="max-width:260px" placeholder="Choose password‚Ä¶">
          <button class="btn primary" id="vault_button" onclick="openVault()">Create & unlock</button>
        </div>
        <div class="helper" id="vault_error" style="color:#fca5a5;margin-top:4px;"></div>

        <div class="label" style="margin-top:12px">BIO-ID (creator_id)</div>
        <pre id="vault_creator">(locked)</pre>

        <div class="label">Public key</div>
        <pre id="vault_pub">(locked)</pre>

        <div class="label">Private key (local ‚Äì shown only here)</div>
        <pre id="vault_priv">(locked)</pre>

        <div class="label">Latest mindprint hash</div>
        <pre id="vault_mind">(locked)</pre>

        <div class="label">Mindprint created at</div>
        <pre id="vault_created">‚Äì</pre>
      </div>
    </section>

    <section id="admin-about" class="hide">
      <div class="card">
        <div class="label"><b>How SignAi works ‚Äì simple view</b></div>
        <div class="helper">
          SignAi is a local-first system for proving that a piece of content (text + optional image) was created by a specific human, on a specific device, within a short time-window.
        </div>
        <ol class="helper" style="margin-left:18px;margin-top:6px">
          <li><b>Vault</b> ‚Äì You choose a password that unlocks your local BIO-ID Vault.</li>
          <li><b>Keys</b> ‚Äì SignAi generates an Ed25519 keypair and stores it only on this device.</li>
          <li><b>Mindprint</b> ‚Äì You type a few sentences; timing & rhythm become a <code>mind_hash</code>.</li>
          <li><b>TraceNet (local)</b> ‚Äì Your <code>creator_id</code> is derived from your public key and linked to your mindprint.</li>
          <li><b>TRACE badge</b> ‚Äì When you sign content, SignAi hashes (text + optional image), runs <b>ORIGIN-X</b> (Winston, image only), signs a token, then renders a badge.</li>
          <li><b>Verify</b> ‚Äì Anyone can validate the signature + short time window + local TraceNet + mindprint + optional image hash.</li>
        </ol>
      </div>
    </section>
  </section>

  <footer class="helper">SignAi ¬© 2025 ‚Äî HOP 7.0 Alpha ‚Ä¢ Local-first ‚Ä¢ WebCrypto Ed25519</footer>
</div>

<script>
let MEMORY_STORAGE = {};
let STORAGE_WORKS = true;
try { localStorage.setItem("__signai_test","1"); localStorage.removeItem("__signai_test"); }
catch(e){ STORAGE_WORKS=false; console.warn("localStorage BLOCKED ‚Äì using in-memory storage instead."); }

const store = {
  set(key,val){ if(STORAGE_WORKS) localStorage.setItem(key,val); else MEMORY_STORAGE[key]=val; },
  get(key){ if(STORAGE_WORKS) return localStorage.getItem(key); return Object.prototype.hasOwnProperty.call(MEMORY_STORAGE,key)?MEMORY_STORAGE[key]:null; },
  remove(key){ if(STORAGE_WORKS) localStorage.removeItem(key); else delete MEMORY_STORAGE[key]; }
};

const signai_logo = document.getElementById('signai_logo');
const st1=document.getElementById('st1'),st2=document.getElementById('st2'),st3=document.getElementById('st3'),st4=document.getElementById('st4'),st5=document.getElementById('st5');
const btnPrev=document.getElementById('btnPrev'),btnNext=document.getElementById('btnNext');

const k_status=document.getElementById('k_status');
const h_status=document.getElementById('h_status'),h_text=document.getElementById('h_text');

const tn_creator=document.getElementById('tn_creator'),tn_regstatus=document.getElementById('tn_regstatus');

const c_text=document.getElementById('c_text'),c_image=document.getElementById('c_image'),c_thumb=document.getElementById('c_thumb');
const b_preview=document.getElementById('b_preview'),b_preview_hint=document.getElementById('b_preview_hint');

const v_file=document.getElementById('v_file'),v_img=document.getElementById('v_img');
const v_box=document.getElementById('v_box'),v_human_status=document.getElementById('v_human_status'),v_human_sub=document.getElementById('v_human_sub');
const v_checks_panel=document.getElementById('v_checks');
const chk_sign=document.getElementById('chk_sign'),chk_time=document.getElementById('chk_time'),chk_creator=document.getElementById('chk_creator'),chk_mind=document.getElementById('chk_mind'),chk_img=document.getElementById('chk_img'),chk_summary=document.getElementById('chk_summary');

const vault_status=document.getElementById('vault_status'),vault_error=document.getElementById('vault_error');
const vault_creator=document.getElementById('vault_creator'),vault_pub=document.getElementById('vault_pub'),vault_priv=document.getElementById('vault_priv');
const vault_mind=document.getElementById('vault_mind'),vault_created=document.getElementById('vault_created');
const vault_pass=document.getElementById('vault_pass'),vault_button=document.getElementById('vault_button');

const co_status=document.getElementById('co_status'),co_details=document.getElementById('co_details');

/* NAV */
const ADMIN_PIN="1996";
let currentTab='trace';
const tabOrder=['trace','verify','admin'];

function ensureAdminUnlocked(){
  try{ if(sessionStorage.getItem("sa_admin_ok")==="1") return true; }catch(_e){}
  const pin = prompt("PIN required");
  if(pin===ADMIN_PIN){ try{sessionStorage.setItem("sa_admin_ok","1");}catch(_e){} return true; }
  alert("Wrong PIN.");
  return false;
}
function switchTab(name,btn){
  if(name==='admin' && !ensureAdminUnlocked()) return;
  currentTab=name;

  document.querySelectorAll('.nav .tab').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');

  ['trace','verify','admin'].forEach(n=>{
    const el=document.getElementById('tab-'+n);
    if(el) el.classList.add('hide');
  });
  const active=document.getElementById('tab-'+name);
  if(active) active.classList.remove('hide');

  [st1,st2,st3,st4,st5].forEach(el=>el && el.classList.remove('active'));
  if(name==='trace'){ [st1,st2,st3,st4].forEach(el=>el && el.classList.add('active')); }
  if(name==='verify'){ [st1,st2,st3,st4,st5].forEach(el=>el && el.classList.add('active')); }
  if(name==='admin'){ [st1,st2,st3,st4,st5].forEach(el=>el && el.classList.add('active')); }

  updatePager();
}
function goNext(){ const i=tabOrder.indexOf(currentTab); if(i<tabOrder.length-1){ const t=tabOrder[i+1]; switchTab(t, document.getElementById('tb_'+t)); } }
function goPrev(){ const i=tabOrder.indexOf(currentTab); if(i>0){ const t=tabOrder[i-1]; switchTab(t, document.getElementById('tb_'+t)); } }
function updatePager(){ const i=tabOrder.indexOf(currentTab); if(btnPrev) btnPrev.disabled=(i<=0); if(btnNext) btnNext.disabled=(i>=tabOrder.length-1); }
switchTab('trace', document.getElementById('tb_trace'));

/* Admin sub tabs */
let adminSub='signai';
function switchAdmin(which,btn){
  adminSub=which;
  document.querySelectorAll('.adminNav .tab').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  ['signai','vault','about'].forEach(n=>{
    const el=document.getElementById('admin-'+n);
    if(el) el.classList.add('hide');
  });
  const active=document.getElementById('admin-'+which);
  if(active) active.classList.remove('hide');
}

function applyLogos(){ if(signai_logo && !signai_logo.getAttribute('src')) signai_logo.src='logo.png'; }
applyLogos();

const enc = new TextEncoder();

function b64u(bytes){ let s=btoa(String.fromCharCode(...bytes)); return s.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }
function fromB64u(s){
  const pad='='.repeat((4-(s.length%4))%4);
  s=s.replace(/-/g,'+').replace(/_/g,'/')+pad;
  const bin=atob(s); const u=new Uint8Array(bin.length);
  for(let i=0;i<u.length;i++) u[i]=bin.charCodeAt(i);
  return u;
}

async function sha256HexBuffer(buf){
  if(!window.crypto || !crypto.subtle) throw new Error('WebCrypto (crypto.subtle) not supported.');
  const hashBuf = await crypto.subtle.digest('SHA-256', buf);
  const u = new Uint8Array(hashBuf);
  return [...u].map(b=>b.toString(16).padStart(2,'0')).join('');
}
async function sha256Hex(text){ return sha256HexBuffer(enc.encode(text)); }

async function kpGenerate(){
  if(!window.crypto || !crypto.subtle) throw new Error('WebCrypto (crypto.subtle) not supported.');
  const keyPair = await crypto.subtle.generateKey({ name:'Ed25519' }, true, ['sign','verify']);
  const pubRaw=await crypto.subtle.exportKey('raw', keyPair.publicKey);
  const privPkcs=await crypto.subtle.exportKey('pkcs8', keyPair.privateKey);
  return { publicKey:new Uint8Array(pubRaw), privateKey:new Uint8Array(privPkcs) };
}
async function getStoredPrivateKey(){
  const raw=store.get('sa_priv'); if(!raw) return null;
  const j=JSON.parse(raw); if(!j.edSecret) return null;
  const pkcs8Bytes=fromB64u(j.edSecret);
  return crypto.subtle.importKey('pkcs8', pkcs8Bytes, {name:'Ed25519'}, false, ['sign']);
}
async function signBytesEd25519(msgBytes){
  const privKey=await getStoredPrivateKey();
  if(!privKey) throw new Error('No private ED25519 key found.');
  const sigBuf=await crypto.subtle.sign({name:'Ed25519'}, privKey, msgBytes);
  return new Uint8Array(sigBuf);
}
async function verifyBytesEd25519(msgBytes, sigB64u, pubB64u){
  const sigBytes=fromB64u(sigB64u);
  const pubBytes=fromB64u(pubB64u);
  const pubKey=await crypto.subtle.importKey('raw', pubBytes, {name:'Ed25519'}, false, ['verify']);
  return crypto.subtle.verify({name:'Ed25519'}, pubKey, sigBytes, msgBytes);
}

/* KEY MGMT */
function setKeyStatus(msg){ if(k_status) k_status.textContent=msg; }

async function createKey(){
  try{
    const vaultHash=store.get('sa_vault_hash');
    const vaultUnlocked=store.get('sa_vault_unlocked')==='1';
    if(!vaultHash || !vaultUnlocked){ alert('Set and unlock your BIO-ID Vault password first (Admin ‚Üí Vault).'); return; }

    const kp=await kpGenerate();
    store.set('sa_priv', JSON.stringify({edSecret:b64u(kp.privateKey)}));
    store.set('sa_pub',  JSON.stringify({edPublic:b64u(kp.publicKey)}));
    setKeyStatus('Keypair created locally with WebCrypto (Ed25519).');
    updateKeyDisplay();
    ensureTraceNetRegistered();
    loadVault();
  }catch(e){ console.error(e); setKeyStatus('Error creating key: '+e.message); }
}

function downloadPub(){
  const pub=store.get('sa_pub'); if(!pub){ alert('No public key.'); return; }
  const blob=new Blob([pub],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a');
  a.href=url; a.download='signai_public_key.json'; a.click(); URL.revokeObjectURL(url);
}
function exportPriv(){
  const priv=store.get('sa_priv'); if(!priv){ alert('No private key.'); return; }
  if(!confirm('Export private key? NEVER share this file.')) return;
  const blob=new Blob([priv],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a');
  a.href=url; a.download='signai_private_key.json'; a.click(); URL.revokeObjectURL(url);
}
function importPriv(e){
  const f=e.target.files[0]; if(!f) return;
  f.text().then(t=>{
    try{
      const j=JSON.parse(t);
      if(j.edSecret){
        store.set('sa_priv', JSON.stringify(j));
        setKeyStatus('Private key imported.');
        updateKeyDisplay();
        ensureTraceNetRegistered();
        loadVault();
      }else throw new Error('Unknown key structure');
    }catch(err){ setKeyStatus('Error: '+err.message); }
  });
}

function updateKeyDisplay(){
  const pubEl=document.getElementById('k_pub');
  const privEl=document.getElementById('k_priv');
  const btn=document.getElementById('btnTogglePriv');

  const pubRaw=store.get('sa_pub');
  const privRaw=store.get('sa_priv');

  if(pubEl){
    if(pubRaw){
      try{ const j=JSON.parse(pubRaw); pubEl.textContent=j.edPublic || '(unknown format)'; }
      catch(_e){ pubEl.textContent='(error reading public key)'; }
    }else pubEl.textContent='(none)';
  }

  if(privEl){
    if(privRaw){
      privEl.dataset.real=privRaw;
      privEl.dataset.shown='0';
      privEl.textContent='(hidden)';
      if(btn) btn.disabled=false;
    }else{
      privEl.dataset.real='';
      privEl.dataset.shown='0';
      privEl.textContent='(none)';
      if(btn) btn.disabled=true;
    }
  }
}
function togglePriv(){
  const privEl=document.getElementById('k_priv');
  const btn=document.getElementById('btnTogglePriv');
  if(!privEl || !btn) return;
  const real=privEl.dataset.real||'';
  const shown=privEl.dataset.shown==='1';
  if(!real){ privEl.textContent='(none)'; btn.disabled=true; return; }
  if(shown){ privEl.textContent='(hidden)'; privEl.dataset.shown='0'; btn.textContent='Show'; }
  else{ privEl.textContent=real; privEl.dataset.shown='1'; btn.textContent='Hide'; }
}

/* MINDPRINT */
let h_log=[];
function logKey(e){ h_log.push({t:performance.now(),k:e.key}); }
function computeMindprint(){
  if(!h_log.length || !h_text) return null;
  if(h_log.length<8) return null;
  const ts=h_log.map(x=>x.t);
  const dt=[]; for(let i=1;i<ts.length;i++) dt.push(ts[i]-ts[i-1]);
  if(dt.length===0) return null;
  const mean=dt.reduce((a,b)=>a+b,0)/dt.length;
  const varc=dt.reduce((a,b)=>a+(b-mean)*(b-mean),0)/dt.length;
  const sd=Math.sqrt(varc);
  const flatRatio=dt.filter(x=>Math.abs(x-mean)<8).length/dt.length;
  const totalDuration=ts[ts.length-1]-ts[0];
  const textLen=h_text.value.length;
  const cps=totalDuration>0 ? textLen/(totalDuration/1000) : 0;
  const backspaces=h_log.filter(x=>x.k==='Backspace').length;
  const spaces=h_log.filter(x=>x.k===' ').length;
  const enters=h_log.filter(x=>x.k==='Enter').length;
  return {version:'mp-v2',meanInterval:mean,sdInterval:sd,flatRatio,totalDurationMs:totalDuration,length:textLen,charsPerSec:cps,backspaceFreq:backspaces/Math.max(1,textLen),spaceFreq:spaces/Math.max(1,textLen),enterCount:enters};
}
function updateMindprint(){
  const f=computeMindprint();
  if(!f) return;
  sha256Hex(JSON.stringify(f)).then(h=>{
    store.set('mindprint', JSON.stringify({mind_hash:h,created_at:new Date().toISOString()}));
    if(h_status) h_status.textContent='Human mindprint registered ‚úîÔ∏é';
    ensureTraceNetRegistered();
    loadVault();
  }).catch(err=>{ console.error(err); if(h_status) h_status.textContent='Error hashing mindprint: '+err.message; });
}

/* TraceNet */
function getTraceNet(){ try{ return JSON.parse(store.get('tracenet')||'{}'); }catch(_e){ return {}; } }
function putTraceNet(obj){ store.set('tracenet', JSON.stringify(obj)); }
async function creatorId(pub){ const h=await sha256Hex(JSON.stringify(pub)); return 'sha256:'+h; }
let lastCreatorId=null;

async function ensureTraceNetRegistered(){
  const pub=store.get('sa_pub'); const mp=store.get('mindprint');
  if(!pub || !mp){ renderTraceNetStatus(); return; }
  const pubObj=JSON.parse(pub);
  const mpObj=JSON.parse(mp);
  const id='sha256:'+await sha256Hex(JSON.stringify(pubObj));
  const tn=getTraceNet();
  if(!tn[id]) tn[id]={ public:pubObj, mind:mpObj.mind_hash, created_at:new Date().toISOString() };
  else{ tn[id].mind=mpObj.mind_hash; tn[id].updated_at=new Date().toISOString(); }
  putTraceNet(tn);
  renderTraceNetStatus();
}
async function renderTraceNetStatus(){
  const pub=store.get('sa_pub'); const tn=getTraceNet();
  if(!pub){
    if(tn_creator) tn_creator.textContent='(missing ‚Äì create key first in Admin)';
    if(tn_regstatus) tn_regstatus.textContent='No ‚Äì no public key yet.';
    lastCreatorId=null;
    return;
  }
  const pubObj=JSON.parse(pub);
  const cid='sha256:'+await sha256Hex(JSON.stringify(pubObj));
  lastCreatorId=cid;
  if(tn_creator) tn_creator.textContent=cid;
  if(tn_regstatus){
    let base = tn[cid] ? 'Yes ‚Äì registered locally.' : 'No ‚Äì not found in local TraceNet.';
    if(!STORAGE_WORKS) base += ' (Sandbox mode without persistent storage).';
    tn_regstatus.textContent=base;
  }
}

/* Vault */
async function renderVault(){
  if(!vault_status) return;
  const unlocked=store.get('sa_vault_unlocked')==='1';
  const storedHash=store.get('sa_vault_hash');

  if(unlocked){
    vault_status.textContent='Vault is unlocked on this device.';
    if(vault_error) vault_error.textContent='';
    if(vault_button){ vault_button.textContent='Lock'; vault_button.onclick=lockVault; }
    if(vault_pass){ vault_pass.placeholder='Vault unlocked'; vault_pass.value=''; }

    const pubRaw=store.get('sa_pub'), privRaw=store.get('sa_priv'), mpRaw=store.get('mindprint');
    let cid='(missing)';
    if(pubRaw){
      try{
        const pubObj=JSON.parse(pubRaw);
        cid='sha256:'+await sha256Hex(JSON.stringify(pubObj));
        if(vault_pub) vault_pub.textContent=pubObj.edPublic || '(unknown format)';
      }catch(_e){ if(vault_pub) vault_pub.textContent='(error reading public key)'; }
    }else{ if(vault_pub) vault_pub.textContent='(no key yet)'; }
    if(vault_creator) vault_creator.textContent=cid;

    if(vault_priv) vault_priv.textContent = privRaw ? privRaw : '(no private key yet)';

    if(mpRaw){
      try{
        const mpObj=JSON.parse(mpRaw);
        if(vault_mind) vault_mind.textContent=mpObj.mind_hash || '(missing)';
        if(vault_created) vault_created.textContent=mpObj.created_at || '(unknown)';
      }catch(_e){
        if(vault_mind) vault_mind.textContent='(error reading mindprint)';
        if(vault_created) vault_created.textContent='‚Äì';
      }
    }else{
      if(vault_mind) vault_mind.textContent='(no mindprint yet)';
      if(vault_created) vault_created.textContent='‚Äì';
    }
  }else{
    vault_status.textContent = storedHash ? 'Vault locked. Enter your password to unlock.' : 'No Vault password set. Choose a password to create your BIO-ID Vault.';
    if(vault_error) vault_error.textContent='';
    if(vault_button){ vault_button.textContent=storedHash?'Unlock':'Create & unlock'; vault_button.onclick=openVault; }
    if(vault_pass){ vault_pass.placeholder=storedHash?'Password‚Ä¶':'Choose new password‚Ä¶'; vault_pass.value=''; }
    if(vault_creator) vault_creator.textContent='(locked)';
    if(vault_pub) vault_pub.textContent='(locked)';
    if(vault_priv) vault_priv.textContent='(locked)';
    if(vault_mind) vault_mind.textContent='(locked)';
    if(vault_created) vault_created.textContent='‚Äì';
  }
}
function loadVault(){ renderVault(); }
async function openVault(){
  if(!vault_pass) return;
  const pass=vault_pass.value||'';
  const storedHash=store.get('sa_vault_hash');
  if(!storedHash){
    if(!pass){ if(vault_error) vault_error.textContent='Choose a password first.'; return; }
    const h=await sha256Hex(pass);
    store.set('sa_vault_hash',h);
    store.set('sa_vault_unlocked','1');
    await renderVault();
  }else{
    const h=await sha256Hex(pass);
    if(h===storedHash){ store.set('sa_vault_unlocked','1'); await renderVault(); }
    else{ if(vault_error) vault_error.textContent='Wrong password.'; }
  }
}
function lockVault(){ store.set('sa_vault_unlocked','0'); renderVault(); }

/* Badge / origin / verify */
let lastToken=null, lastSvg=null, attachedImageFile=null, attachedImageHash=null, attachedThumbDataURL=null;
let badgeTimerInterval=null;

async function handleImage(e){
  const f=e.target.files[0]; if(!f) return;
  attachedImageFile=f;
  const buf=await f.arrayBuffer();
  attachedImageHash=await sha256HexBuffer(buf);

  const img=new Image();
  img.onload=()=>{
    const can=document.createElement('canvas');
    const maxW=260;
    const scale=Math.min(1,maxW/img.width);
    can.width=Math.round(img.width*scale);
    can.height=Math.round(img.height*scale);
    can.getContext('2d').drawImage(img,0,0,can.width,can.height);
    attachedThumbDataURL=can.toDataURL('image/png',0.9);
    if(c_thumb){ c_thumb.src=attachedThumbDataURL; c_thumb.classList.remove('hide'); }
  };
  img.src=URL.createObjectURL(f);
}

function canonicalize(o){
  if(o===null || typeof o!=='object') return o;
  if(Array.isArray(o)) return o.map(canonicalize);
  const out={}; Object.keys(o).sort().forEach(k=>out[k]=canonicalize(o[k]));
  return out;
}
function canonicalJSONString(o){ return JSON.stringify(canonicalize(o)); }

function startBadgeCountdown(targetMs){
  if(badgeTimerInterval){ clearInterval(badgeTimerInterval); badgeTimerInterval=null; }
  if(!b_preview) return;
  const svgRoot=b_preview.querySelector('svg'); if(!svgRoot) return;
  const textEl=svgRoot.querySelector('#timerText');
  const dotEl=svgRoot.querySelector('#timerDot');
  function tick(){
    const now=Date.now();
    let r=Math.round((targetMs-now)/1000); if(r<0) r=0;
    if(textEl) textEl.textContent=r+'s';
    if(r<=0){ if(dotEl) dotEl.setAttribute('fill','#3b82f6'); clearInterval(badgeTimerInterval); badgeTimerInterval=null; }
  }
  tick(); badgeTimerInterval=setInterval(tick,1000);
}

async function callOnlineAIDetector(file){
  const dataUrl = await new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onload=()=>resolve(reader.result);
    reader.onerror=reject;
    reader.readAsDataURL(file);
  });

  const img=new Image();
  await new Promise((resolve,reject)=>{ img.onload=resolve; img.onerror=reject; img.src=dataUrl; });

  const min=256;
  const w0=img.naturalWidth||img.width;
  const h0=img.naturalHeight||img.height;
  const scale=Math.max(min/w0, min/h0, 1);
  const w=Math.round(w0*scale), h=Math.round(h0*scale);

  const canvas=document.createElement("canvas");
  canvas.width=w; canvas.height=h;
  canvas.getContext("2d").drawImage(img,0,0,w,h);

  const jpegBlob = await new Promise((resolve)=>{ canvas.toBlob(b=>resolve(b),"image/jpeg",0.92); });
  const blobToSend = jpegBlob || file;

  const form=new FormData();
  form.append("image", blobToSend, "upload.jpg");

  try{
    const res = await fetch("https://signai-tamy.onrender.com/detect-image", { method:"POST", body:form });
    const rawText = await res.text();
    let data=null; try{ data=JSON.parse(rawText); }catch(_e){}
    if(!res.ok){
      const msg=data?.label||data?.error||data?.message||rawText?.slice(0,180)||("HTTP error "+res.status);
      return { ai_score:0.5, label:"Backend/Winston error: "+msg, version:data?.version||"signai-backend", raw:data||rawText };
    }
    const cand=data?.ai_score;
    const aiScore=(typeof cand==="number" && Number.isFinite(cand)) ? (cand>1? cand/100 : cand) : 0.5;
    const label=(typeof data?.label==="string" && data.label) ? data.label : "Unknown";
    return { ai_score:aiScore, label, version:data?.version||"winston-ai", raw:data };
  }catch(err){
    return { ai_score:0.5, label:"Network error contacting backend: "+err.message, version:"signai-backend", raw:null };
  }
}

function renderContentOrigin(info){
  if(!info){
    if(co_status) co_status.textContent='Analyzing content origin‚Ä¶';
    if(co_details) co_details.textContent='';
    return;
  }
  const scoreTxt=(info.score!==undefined) ? (info.score*100).toFixed(1)+'%' : 'N/A';
  if(co_status) co_status.textContent=`${info.label} (${scoreTxt})`;
  if(co_details){
    const lines=[];
    if(info.image){
      lines.push(`IMAGE SCORE: ${(info.image.score*100).toFixed(1)}% ‚Üí ${info.image.label}`);
      if(info.image.hash) lines.push(`Image hash: ${info.image.hash}`);
      lines.push('');
    }
    if(info.explanation){ lines.push('EXPLANATION:'); lines.push(info.explanation); lines.push(''); }
    co_details.textContent=lines.join('\n');
  }
}

async function buildGlyphSvg(seed, originScore, isAI){
  const h=await sha256Hex(seed);
  const human=['#22b7ff','#22e0d8','#4ade80','#22c55e'];
  const ai=['#ef4444','#fb7185','#f97316','#facc15'];
  const colors=isAI?ai:human;
  const accent=isAI?'#ef4444':'#1d4ed8';
  const chip2=isAI?'AI':'HUMAN';
  const grid=4, cell=22, margin=10;
  let shapes='';
  for(let i=0;i<grid*grid;i++){
    const val=parseInt(h[i],16);
    if((val%2)===0){
      const row=Math.floor(i/grid), col=i%grid;
      const cx=margin+cell/2+col*cell;
      const cy=margin+cell/2+row*cell;
      const r=4+(val%4);
      const color=colors[val%colors.length];
      shapes+=`<circle cx="${cx}" cy="${cy}" r="${r}" fill="${color}" opacity="0.92"><animate attributeName="r" values="${r};${r+1.5};${r}" dur="${1+val/32}s" repeatCount="indefinite"/></circle>`;
    }
  }
  return `  <g id="trace_fp" transform="translate(20,22)">
    <rect x="0" y="0" width="140" height="126" rx="22" fill="#020617" stroke="#1e293b" stroke-width="1.2"/>
    <rect x="3" y="3" width="134" height="120" rx="20" fill="#020617" stroke="#111827" stroke-width="1"/>
    <rect x="3" y="3" width="134" height="120" rx="20" fill="none" stroke="${accent}" stroke-width="0.9" opacity="0.75"/>
    <g transform="translate(14,14)"><g>${shapes}<animateTransform attributeName="transform" type="rotate" from="0 44 44" to="360 44 44" dur="18s" repeatCount="indefinite"/></g></g>
    <g transform="translate(10,102)">
      <rect x="0" y="0" width="32" height="16" rx="7" fill="#020617" stroke="#1e293b" stroke-width="1"/>
      <text x="16" y="11" text-anchor="middle" font-family="system-ui" font-size="9" fill="#a5b4fc">ORIGIN</text>
      <rect x="38" y="0" width="34" height="16" rx="7" fill="#020617" stroke="#1e293b" stroke-width="1"/>
      <text x="55" y="11" text-anchor="middle" font-family="system-ui" font-size="9" fill="#a5b4fc">${chip2}</text>
      <rect x="78" y="0" width="32" height="16" rx="7" fill="#020617" stroke="#1e293b" stroke-width="1"/>
      <text x="94" y="11" text-anchor="middle" font-family="system-ui" font-size="9" fill="#a5b4fc">TT</text>
    </g>
  </g>`;
}

async function buildBadge(){
  try{
    const txt=(c_text?c_text.value:'')||'';
    if(!txt.trim()){ alert('Write or paste some text first.'); return; }
    const privRaw=store.get('sa_priv'), pubRaw=store.get('sa_pub');
    if(!privRaw || !pubRaw){ alert('Create/import key first (Admin ‚Üí Creator).'); return; }
    const mpRaw=store.get('mindprint');
    if(!mpRaw){ alert('Create your mindprint first (Admin ‚Üí Creator).'); return; }

    renderContentOrigin(null);

    let originInfo;
    if(attachedImageFile){
      const online=await callOnlineAIDetector(attachedImageFile);
      originInfo={
        score:online.ai_score,
        label:online.label,
        explanation:`Winston AI image detection: score ${online.ai_score.toFixed(3)} ‚Üí ${online.label} (model: ${online.version||'winston-ai'})`,
        text:null,
        image:{score:online.ai_score,label:online.label,hash:attachedImageHash||null}
      };
    }else{
      originInfo={score:0.30,label:'Human (no image, not scanned)',explanation:'No image attached. Winston AI runs only on images.',text:null,image:null};
    }

    const isAI = (typeof originInfo.score==='number') && originInfo.score>=0.50;
    renderContentOrigin(originInfo);

    if(b_preview){
      b_preview.classList.remove('ok','bad','expired');
      b_preview.classList.add(isAI?'bad':'ok');
    }

    const mp=JSON.parse(mpRaw);
    const content_hash=await sha256Hex(txt);
    const session={issued_at:new Date().toISOString(),expires_in:60,nonce:[...crypto.getRandomValues(new Uint8Array(8))].map(b=>b.toString(16).padStart(2,'0')).join('')};
    const pubJ=JSON.parse(pubRaw);

    const tokenCore={
      version:'trace-7.0',scheme:'signai-trace',content_type:'text/plain',
      content_hash,created_at:session.issued_at,
      metadata:{
        creator_id:await creatorId(pubJ),
        mindprint:{mind_hash:mp.mind_hash},
        image_hash:attachedImageHash||null,
        content_origin:{score:originInfo.score,label:originInfo.label,text:null,image:originInfo.image||null},
        session
      }
    };

    const msg=enc.encode(canonicalJSONString(tokenCore));
    const sig=await signBytesEd25519(msg);

    const token={...tokenCore, proof:{alg:'Ed25519',edPublic:pubJ.edPublic,sig:b64u(sig)}};
    lastToken=token;

    const encoded=btoa(unescape(encodeURIComponent(JSON.stringify(token))));
    const prefix=isAI?'AI':'HUMAN';
    const shortCode=(await sha256Hex(content_hash+(attachedImageHash||'')+session.nonce)).slice(0,10).toUpperCase();
    const humanCode=`${prefix}: ${shortCode}`;

    const thumb = attachedThumbDataURL ?
      `<g transform="translate(134,18)">
        <rect x="0" y="0" width="40" height="40" rx="12" fill="#020617" stroke="${isAI?'#ef4444':'#22b7ff'}" stroke-width="1.2">
          <animate attributeName="stroke-width" values="1.2;2;1.2" dur="2.4s" repeatCount="indefinite"/>
        </rect>
        <rect x="0" y="0" width="40" height="40" rx="12" fill="none" stroke="${isAI?'#fb7185':'#22e0d8'}" stroke-width="0.6" opacity="0.6">
          <animate attributeName="opacity" values="0.4;1;0.4" dur="3.5s" repeatCount="indefinite"/>
        </rect>
        <image href="${attachedThumbDataURL}" x="4" y="4" width="32" height="32" preserveAspectRatio="xMidYMid slice" opacity="0.98"/>
      </g>` : '';

    const glyphSeed=content_hash+'|'+(attachedImageHash||'')+'|'+token.metadata.creator_id;
    const glyph=await buildGlyphSvg(glyphSeed, originInfo.score, isAI);

    const titleMain='ORIGIN CHECK (Winston AI)';
    const titleSub=isAI ? 'AI flagged (‚â• 50%)' : 'Human marked (< 50%)';

    const svg=`<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 420 170" width="420" height="170" data-trace="${encoded}" role="img" aria-label="SignAi BIO-ID ‚Äî Proof of Origin (Winston AI)">
  <defs>
    <linearGradient id="bg_grad" x1="0" y="0" x2="1" y="1">
      <stop offset="0" stop-color="#020617"/><stop offset="0.4" stop-color="#020824"/><stop offset="1" stop-color="#020617"/>
    </linearGradient>
    <linearGradient id="border_grad" x1="0" y="0" x2="1" y2="0">
      <stop offset="0" stop-color="${isAI?'#ef4444':'#22b7ff'}"/>
      <stop offset="0.5" stop-color="${isAI?'#fb7185':'#22e0d8'}"/>
      <stop offset="1" stop-color="${isAI?'#f97316':'#5b21ff'}"/>
    </linearGradient>
    <style>
      .title{font:800 16px system-ui;fill:#e5f2ff}
      .subtitle{font:700 12px system-ui;fill:${isAI?'#fecaca':'#bbf7d0'}}
      .label{font:600 11px system-ui;fill:#9fb0c4}
      .value{font:700 12px system-ui;fill:#cfe8ff}
      .code{font:700 12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;letter-spacing:0.08em}
      .chip{font:700 9px system-ui;fill:#a5b4fc}
    </style>
  </defs>

  <rect x="0.5" y="0.5" width="419" height="169" rx="22" fill="url(#bg_grad)"/>
  <rect x="1.5" y="1.5" width="417" height="167" rx="21" fill="none" stroke="url(#border_grad)" stroke-width="1.5"/>

  <g transform="translate(398,18)">
    <circle id="timerDot" cx="0" cy="0" r="6" fill="${isAI?'#ef4444':'#16a34a'}">
      <animate attributeName="r" values="6;7.5;6" dur="1.6s" repeatCount="indefinite"/>
      <animate attributeName="opacity" values="0.35;1;0.35" dur="1.6s" repeatCount="indefinite"/>
    </circle>
  </g>

${glyph}
${thumb}

  <g transform="translate(20,144)">
    <rect x="0" y="-18" width="220" height="22" rx="10" fill="#020617" stroke="#1e293b" stroke-width="1"/>
    <text x="10" y="-4" class="code" fill="#f9fafb">${humanCode}</text>
  </g>

  <g transform="translate(190,30)">
    <text x="0" y="0" class="label">SIGNAI / HOP 7.0 BIO-ID</text>
    <text x="0" y="22" class="title">${titleMain}</text>
    <text x="0" y="40" class="subtitle">${titleSub}</text>

    <text x="0" y="60" class="label">MODE</text>
    <text x="84" y="60" class="value">Proof of Origin (BIO-ID + Winston)</text>

    <text x="0" y="78" class="label">WINDOW</text>
    <text x="84" y="78" class="value">TRACE ¬∑ <tspan id="timerText">60s</tspan> window</text>

    <text x="0" y="96" class="label">CREATOR_ID</text>
    <text x="84" y="96" class="value">${token.metadata.creator_id}</text>

    <text x="0" y="114" class="label">CONTENT ORIGIN</text>
    <text x="84" y="114" class="value">${originInfo.label}</text>

    <text x="0" y="132" class="label">ORIGIN SCORE</text>
    <text x="84" y="132" class="value" fill="${isAI?'#fecaca':'#bbf7d0'}">${(originInfo.score*100).toFixed(1)} %</text>

    <g transform="translate(0,144)">
      <rect x="0" y="0" width="60" height="18" rx="9" fill="#020617" stroke="#1e293b"/><text x="30" y="13" text-anchor="middle" class="chip">ORIGIN</text>
      <rect x="68" y="0" width="60" height="18" rx="9" fill="#020617" stroke="#1e293b"/><text x="98" y="13" text-anchor="middle" class="chip">${isAI?'AI':'HUMAN'}</text>
      <rect x="136" y="0" width="60" height="18" rx="9" fill="#020617" stroke="#1e293b"/><text x="166" y="13" text-anchor="middle" class="chip">TRACE¬∑TT</text>
    </g>
  </g>
</svg>`;

    lastSvg=svg;

    if(b_preview){
      b_preview.innerHTML=svg;
      b_preview.classList.add('clickable');
      b_preview.onclick=()=>{ quickVerifyCurrent(); switchTab('verify', document.getElementById('tb_verify')); };
    }
    if(b_preview_hint) b_preview_hint.classList.remove('hide');

    const expiresAt = new Date(session.issued_at).getTime() + session.expires_in*1000;
    startBadgeCountdown(expiresAt);

    ensureTraceNetRegistered();
  }catch(err){ console.error(err); alert('Error creating badge: '+err.message); }
}

function downloadSVG(){
  if(!lastSvg){ alert('No badge yet.'); return; }
  const blob=new Blob([lastSvg],{type:'image/svg+xml'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='signai_hop7_badge.svg'; a.click();
  URL.revokeObjectURL(url);
}
function downloadJSON(){
  if(!lastToken){ alert('No badge yet.'); return; }
  const blob=new Blob([JSON.stringify(lastToken,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='signai_trace_token.json'; a.click();
  URL.revokeObjectURL(url);
}

/* Verify helpers */
function vSetVisual(statusLabel, subText, boxMode){
  if(v_human_status) v_human_status.textContent=statusLabel;
  if(v_human_sub) v_human_sub.textContent=subText;
  if(v_box){
    v_box.className='resultBox';
    if(boxMode==='ok') v_box.classList.add('ok');
    if(boxMode==='bad') v_box.classList.add('bad');
    if(boxMode==='expired') v_box.classList.add('expired');
  }
}
function resetChecks(){
  if(!v_checks_panel) return;
  v_checks_panel.classList.add('hide');
  [chk_sign,chk_time,chk_creator,chk_mind,chk_img].forEach(el=>{
    if(!el) return;
    el.className='check-pill check-na';
    el.textContent='N/A';
  });
  if(chk_summary) chk_summary.textContent='Signal-score: ‚Äì/5. No checks yet.';
}
function setCheck(el,state){
  if(!el) return;
  el.className='check-pill';
  if(state==='ok'){ el.classList.add('check-ok'); el.textContent='OK'; }
  else if(state==='fail'){ el.classList.add('check-fail'); el.textContent='FAIL'; }
  else{ el.classList.add('check-na'); el.textContent='N/A'; }
}
function parseBadgeFromText(text){
  try{ return JSON.parse(text); }catch(_e){}
  const m=text.match(/data-trace="([^"]+)"/i);
  if(m){
    try{ const raw=decodeURIComponent(escape(atob(m[1]))); return JSON.parse(raw); }catch(_e){}
  }
  return null;
}
async function fileToHash(file){ if(!file) return null; const buf=await file.arrayBuffer(); return await sha256HexBuffer(buf); }

async function verifyToken(token, maybeImageFile){
  resetChecks();
  if(!token || !token.proof || !token.proof.sig){ vSetVisual('INVALID BADGE ‚ùå','Badge is missing proof data.','bad'); return; }

  const core={...token}; delete core.proof;
  const msg=enc.encode(canonicalJSONString(core));

  let sigOK=false;
  try{ sigOK=await verifyBytesEd25519(msg, token.proof.sig, token.proof.edPublic); }catch(e){ console.error(e); sigOK=false; }

  let expired=false;
  try{
    const issued=Date.parse(token.metadata?.session?.issued_at || token.created_at || 0);
    const expMs=(token.metadata?.session?.expires_in ?? 0)*1000;
    if(!isNaN(issued) && expMs>0) expired = (Date.now() > (issued+expMs));
  }catch(_e){ expired=false; }

  const tn=getTraceNet();
  const cid=token.metadata?.creator_id;
  let creatorOK=false, mindOK=false;
  if(cid && tn[cid]){
    creatorOK=true;
    const storedMind=tn[cid].mind;
    const tokenMind=token.metadata?.mindprint?.mind_hash;
    if(storedMind && tokenMind && storedMind===tokenMind) mindOK=true;
  }

  let imgOK=true;
  if(token.metadata?.image_hash){
    if(maybeImageFile){
      const upHash=await fileToHash(maybeImageFile);
      imgOK = (!!upHash && upHash===token.metadata.image_hash);
    }else imgOK=true;
  }

  if(expired) vSetVisual('EXPIRED ‚è≥','Badge was valid, but the 60s window has passed.','expired');
  else if(!sigOK) vSetVisual('VERIFICATION FAILED ‚ùå','Signature does not match public key (invalid badge).','bad');

  const checks={signatur:sigOK,tid:!expired,creator:creatorOK,mindprint:mindOK,bild:imgOK};
  const passed=Object.values(checks).filter(Boolean).length;

  if(sigOK && !expired && passed>=4){
    let summary='Signature OK, time within window.';
    if(creatorOK) summary+=' TraceNet identity found.';
    if(mindOK) summary+=' Mindprint matches.';
    if(token.metadata?.image_hash && !maybeImageFile) summary+=' Image not verified now, but other signals are strong.';
    else if(token.metadata?.image_hash && imgOK) summary+=' Image hash matches.';
    vSetVisual('HUMAN VERIFIED ‚úÖ', summary, 'ok');
  }else if(!expired && sigOK){
    vSetVisual('VERIFICATION FAILED ‚ùå','Too few signals match (need at least 4/5).','bad');
  }

  if(v_checks_panel) v_checks_panel.classList.remove('hide');
  setCheck(chk_sign, sigOK?'ok':'fail');
  setCheck(chk_time, !expired?'ok':'fail');
  setCheck(chk_creator, creatorOK?'ok':'fail');
  setCheck(chk_mind, cid ? (mindOK?'ok':'fail') : 'na');
  setCheck(chk_img, token.metadata?.image_hash ? (imgOK?'ok':'fail') : 'na');

  if(chk_summary){
    chk_summary.textContent = `Signal-score: ${passed}/5. ` + (passed>=4 ? 'Enough signals satisfied to treat the badge as human-verified.' : 'Too few signals satisfied to verify this badge as human.');
  }
}
async function smartVerify(){
  const badgeFile=v_file && v_file.files ? v_file.files[0] : null;
  const imgFile=v_img && v_img.files ? (v_img.files[0]||null) : null;
  if(!badgeFile){ alert('Upload a TRACE badge (.svg) first.'); return; }
  const text=await badgeFile.text();
  const token=parseBadgeFromText(text);
  if(!token){ alert('Could not read badge data.'); return; }
  await verifyToken(token, imgFile);
}
async function quickVerifyCurrent(){
  const imgFile=v_img && v_img.files ? (v_img.files[0]||null) : null;
  if(!lastToken){ vSetVisual('NO BADGE YET','Create a TRACE badge first in Use.','bad'); resetChecks(); return; }
  await verifyToken(lastToken, imgFile);
}

/* init */
ensureTraceNetRegistered();
renderTraceNetStatus();
updateKeyDisplay();
loadVault();
resetChecks();
</script>
</body>
</html>
